import{c as H}from"./index-9_wjpDOC.js";import{r as ee}from"./remove-undefined-B_oBVupY-oajMeTFk.js";import{a8 as N,a9 as R,aa as k,ab as te,ac as ne,ad as oe,ae as $,af as E,ag as P,ah as _,ai as Y,aj as K,ak as ce,al as G,am as se,an as re}from"./main-CxkuDHIA.js";function ie(e,t){return e.documentsStore.get(e.data.docs,t)}function ue(e){return e.documentsStore.count(e.data.docs)}const F="fulltext",le="hybrid",de="vector";function fe(e,t){return e[1]-t[1]}function he(e,t){return t[1]-e[1]}function ae(e="desc"){return e.toLowerCase()==="asc"?fe:he}function B(e,t,o){const n={},s=t.map(([d])=>d),i=e.documentsStore.getMultiple(e.data.docs,s),a=Object.keys(o),c=e.index.getSearchablePropertiesWithTypes(e.data.index);for(const d of a){let p;if(c[d]==="number"){const{ranges:r}=o[d],h=r.length,y=Array.from({length:h});for(let l=0;l<h;l++){const b=r[l];y[l]=[`${b.from}-${b.to}`,0]}p=Object.fromEntries(y)}n[d]={count:0,values:p??{}}}const g=i.length;for(let d=0;d<g;d++){const p=i[d];for(const r of a){const h=r.includes(".")?N(p,r):p[r],y=c[r],l=n[r].values;switch(y){case"number":{const b=o[r].ranges;j(b,l)(h);break}case"number[]":{const b=new Set,f=o[r].ranges,u=j(f,l,b);for(const S of h)u(S);break}case"boolean":case"enum":case"string":{C(l,y)(h);break}case"boolean[]":case"enum[]":case"string[]":{const u=C(l,y==="boolean[]"?"boolean":"string",new Set);for(const S of h)u(S);break}default:throw R("FACET_NOT_SUPPORTED",y)}}}for(const d of a){const p=n[d];if(p.count=Object.keys(p.values).length,c[d]==="string"){const r=o[d],h=ae(r.sort);p.values=Object.fromEntries(Object.entries(p.values).sort(h).slice(r.offset??0,r.limit??10))}}return n}function j(e,t,o){return n=>{for(const s of e){const i=`${s.from}-${s.to}`;o?.has(i)||n>=s.from&&n<=s.to&&(t[i]===void 0?t[i]=1:(t[i]++,o?.add(i)))}}}function C(e,t,o){const n=t==="boolean"?"false":"";return s=>{const i=s?.toString()??n;o?.has(i)||(e[i]=(e[i]??0)+1,o?.add(i))}}const ge={reducer:(e,t,o,n)=>(t[n]=o,t),getInitialValue:e=>Array.from({length:e})},m=["string","number","boolean"];function M(e,t,o){const n=o.properties,s=n.length,i=e.index.getSearchablePropertiesWithTypes(e.data.index);for(let u=0;u<s;u++){const S=n[u];if(typeof i[S]>"u")throw R("UNKNOWN_GROUP_BY_PROPERTY",S);if(!m.includes(i[S]))throw R("INVALID_GROUP_BY_PROPERTY",S,m.join(", "),i[S])}const a=t.map(([u])=>k(e.internalDocumentIDStore,u)),c=e.documentsStore.getMultiple(e.data.docs,a),g=c.length,d=o.maxResult||Number.MAX_SAFE_INTEGER,p=[],r={};for(let u=0;u<s;u++){const S=n[u],I={property:S,perValue:{}},x=new Set;for(let D=0;D<g;D++){const v=c[D],w=N(v,S);if(typeof w>"u")continue;const T=typeof w!="boolean"?w:""+w,O=I.perValue[T]??{indexes:[],count:0};O.count>=d||(O.indexes.push(D),O.count++,I.perValue[T]=O,x.add(w))}p.push(Array.from(x)),r[S]=I}const h=X(p),y=h.length,l=[];for(let u=0;u<y;u++){const S=h[u],I=S.length,x={values:[],indexes:[]},D=[];for(let v=0;v<I;v++){const w=S[v],T=n[v];D.push(r[T].perValue[typeof w!="boolean"?w:""+w].indexes),x.values.push(w)}x.indexes=te(D).sort((v,w)=>v-w),x.indexes.length!==0&&l.push(x)}const b=l.length,f=Array.from({length:b});for(let u=0;u<b;u++){const S=l[u],I=o.reduce||ge,x=S.indexes.map(T=>({id:a[T],score:t[T][1],document:c[T]})),D=I.reducer.bind(null,S.values),v=I.getInitialValue(S.indexes.length),w=x.reduce(D,v);f[u]={values:S.values,result:w}}return f}function X(e,t=0){if(t+1===e.length)return e[t].map(i=>[i]);const o=e[t],n=X(e,t+1),s=[];for(const i of o)for(const a of n){const c=[i];ne(c,a),s.push(c)}return s}function L(e,t,o,n){const s=oe(t,n);if(s.length===0)return o;const i=s.flatMap(f=>f.consequence.promote);i.sort((f,u)=>f.position-u.position);const a=new Set,c=new Map,g=new Set;for(const f of i){const u=$(e.internalDocumentIDStore,f.doc_id);if(u!==void 0){if(c.has(u)){const S=c.get(u);f.position<S&&c.set(u,f.position);continue}g.has(f.position)||(a.add(u),c.set(u,f.position),g.add(f.position))}}if(c.size===0)return o;const d=o.filter(([f])=>!a.has(f)),p=1e6,r=[];for(const[f,u]of c.entries())o.find(([I])=>I===f)?r.push([f,p-u]):e.documentsStore.get(e.data.docs,f)&&r.push([f,0]);r.sort((f,u)=>{const S=c.get(f[0])??1/0,I=c.get(u[0])??1/0;return S-I});const h=[],y=new Map;for(const f of r){const u=c.get(f[0]);y.set(u,f)}let l=0,b=0;for(;b<d.length+r.length;)if(y.has(b))h.push(y.get(b)),b++;else if(l<d.length)h.push(d[l]),l++,b++;else break;for(const[f,u]of y.entries())f>=h.length&&h.push(u);return h}function Q(e,t,o){const{term:n,properties:s}=t,i=e.data.index;let a=e.caches.propertiesToSearch;if(!a){const r=e.index.getSearchablePropertiesWithTypes(i);a=e.index.getSearchableProperties(i),a=a.filter(h=>r[h].startsWith("string")),e.caches.propertiesToSearch=a}if(s&&s!=="*"){for(const r of s)if(!a.includes(r))throw R("UNKNOWN_INDEX",r,a.join(", "));a=a.filter(r=>s.includes(r))}const c=Object.keys(t.where??{}).length>0;let g;c&&(g=e.index.searchByWhereClause(i,e.tokenizer,t.where,o));let d;const p=t.threshold!==void 0&&t.threshold!==null?t.threshold:1;if(n||s){const r=ue(e);if(d=e.index.search(i,n||"",e.tokenizer,o,a,t.exact||!1,t.tolerance||0,t.boost||{},be(t.relevance),r,g,p),t.exact&&n){const h=n.trim().split(/\s+/);d=d.filter(([y])=>{const l=e.documentsStore.get(e.data.docs,y);if(!l)return!1;for(const b of a){const f=ye(l,b);if(typeof f=="string"&&h.every(S=>new RegExp(`\\b${pe(S)}\\b`).test(f)))return!0}return!1})}}else if(c){const r=ce(i,t.where);r?d=r:d=(g?Array.from(g):[]).map(y=>[+y,0])}else d=Object.keys(e.documentsStore.getAll(e.data.docs)).map(h=>[+h,0]);return d}function pe(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ye(e,t){const o=t.split(".");let n=e;for(const s of o)if(n&&typeof n=="object"&&s in n)n=n[s];else return;return n}function Se(e,t,o){const n=E();function s(){const c=Object.keys(e.data.index.vectorIndexes),g=t.facets&&Object.keys(t.facets).length>0,{limit:d=10,offset:p=0,distinctOn:r,includeVectors:h=!1}=t,y=t.preflight===!0;let l=Q(e,t,o);if(t.sortBy)if(typeof t.sortBy=="function"){const u=l.map(([x])=>x),I=e.documentsStore.getMultiple(e.data.docs,u).map((x,D)=>[l[D][0],l[D][1],x]);I.sort(t.sortBy),l=I.map(([x,D])=>[x,D])}else l=e.sorter.sortBy(e.data.sorting,l,t.sortBy).map(([u,S])=>[$(e.internalDocumentIDStore,u),S]);else l=l.sort(Y);l=L(e,e.data.pinning,l,t.term);let b;y||(b=r?Ee(e,l,p,d,r):q(e,l,p,d));const f={elapsed:{formatted:"",raw:0},hits:[],count:l.length};if(typeof b<"u"&&(f.hits=b.filter(Boolean),h||K(f,c)),g){const u=B(e,l,t.facets);f.facets=u}return t.groupBy&&(f.groups=M(e,l,t.groupBy)),f.elapsed=e.formatElapsedTime(E()-n),f}async function i(){e.beforeSearch&&await P(e.beforeSearch,e,t,o);const c=s();return e.afterSearch&&await _(e.afterSearch,e,t,o,c),c}return e.beforeSearch?.length||e.afterSearch?.length?i():s()}const A={k:1.2,b:.75,d:.5};function be(e){const t=e??{};return t.k=t.k??A.k,t.b=t.b??A.b,t.d=t.d??A.d,t}function J(e,t,o){const n=t.vector;if(n&&(!("value"in n)||!("property"in n)))throw R("INVALID_VECTOR_INPUT",Object.keys(n).join(", "));const s=e.data.index.vectorIndexes[n.property];if(!s)throw R("UNKNOWN_VECTOR_PROPERTY",n.property);const i=s.node.size;if(n?.value.length!==i)throw n?.property===void 0||n?.value.length===void 0?R("INVALID_INPUT_VECTOR","undefined",i,"undefined"):R("INVALID_INPUT_VECTOR",n.property,i,n.value.length);const a=e.data.index;let c;return Object.keys(t.where??{}).length>0&&(c=e.index.searchByWhereClause(a,e.tokenizer,t.where,o)),s.node.find(n.value,t.similarity??se,c)}function Ie(e,t,o="english"){const n=E();function s(){let c=J(e,t,o).sort(Y);c=L(e,e.data.pinning,c,void 0);let g=[];t.facets&&Object.keys(t.facets).length>0&&(g=B(e,c,t.facets));const p=t.vector.property,r=t.includeVectors??!1,h=t.limit??10,y=t.offset??0,l=Array.from({length:h});for(let S=0;S<h;S++){const I=c[S+y];if(!I)break;const x=e.data.docs.docs[I[0]];if(x){r||(x[p]=null);const D={id:k(e.internalDocumentIDStore,I[0]),score:I[1],document:x};l[S]=D}}let b=[];t.groupBy&&(b=M(e,c,t.groupBy));const u=E()-n;return{count:c.length,hits:l.filter(Boolean),elapsed:{raw:Number(u),formatted:G(u)},...g?{facets:g}:{},...b?{groups:b}:{}}}async function i(){e.beforeSearch&&await P(e.beforeSearch,e,t,o);const c=s();return e.afterSearch&&await _(e.afterSearch,e,t,o,c),c}return e.beforeSearch?.length||e.afterSearch?.length?i():s()}function xe(e,t,o){const n=we(Q(e,t,o)),s=J(e,t,o),i=t.hybridWeights;return Re(n,s,t.term??"",i)}function De(e,t,o){const n=E();function s(){let c=xe(e,t,o);c=L(e,e.data.pinning,c,t.term);let g;t.facets&&Object.keys(t.facets).length>0&&(g=B(e,c,t.facets));let p;t.groupBy&&(p=M(e,c,t.groupBy));const r=t.offset??0,h=t.limit??10,y=q(e,c,r,h).filter(Boolean),l=E(),b={count:c.length,elapsed:{raw:Number(l-n),formatted:G(l-n)},hits:y,...g?{facets:g}:{},...p?{groups:p}:{}};if(!(t.includeVectors??!1)){const u=Object.keys(e.data.index.vectorIndexes);K(b,u)}return b}async function i(){e.beforeSearch&&await P(e.beforeSearch,e,t,o);const c=s();return e.afterSearch&&await _(e.afterSearch,e,t,o,c),c}return e.beforeSearch?.length||e.afterSearch?.length?i():s()}function V(e){return e[1]}function we(e){const t=Math.max.apply(Math,e.map(V));return e.map(([o,n])=>[o,n/t])}function W(e,t){return e/t}function ve(e,t){return(o,n)=>o*e+n*t}function Re(e,t,o,n){const s=Math.max.apply(Math,e.map(V)),i=Math.max.apply(Math,t.map(V)),a=n&&n.text&&n.vector,{text:c,vector:g}=a?n:Te(),d=new Map,p=e.length,r=ve(c,g);for(let y=0;y<p;y++){const[l,b]=e[y],f=W(b,s),u=r(f,0);d.set(l,u)}const h=t.length;for(let y=0;y<h;y++){const[l,b]=t[y],f=W(b,i),u=d.get(l)??0;d.set(l,u+r(0,f))}return[...d].sort((y,l)=>l[1]-y[1])}function Te(e){return{text:.5,vector:.5}}function Z(e,t,o){const n=t.mode??F;if(n===F)return Se(e,t,o);if(n===de)return Ie(e,t);if(n===le)return De(e,t);throw R("INVALID_SEARCH_MODE",n)}function Ee(e,t,o,n,s){const i=e.data.docs,a=new Map,c=[],g=new Set,d=t.length;let p=0;for(let r=0;r<d;r++){const h=t[r];if(typeof h>"u")continue;const[y,l]=h;if(g.has(y))continue;const b=e.documentsStore.get(i,y),f=N(b,s);if(!(typeof f>"u"||a.has(f))&&(a.set(f,!0),p++,!(p<=o)&&(c.push({id:k(e.internalDocumentIDStore,y),score:l,document:b}),g.add(y),p>=o+n)))break}return c}function q(e,t,o,n){const s=e.data.docs,i=Array.from({length:n}),a=new Set;for(let c=o;c<n+o;c++){const g=t[c];if(typeof g>"u")break;const[d,p]=g;if(!a.has(d)){const r=e.documentsStore.get(s,d);i[c]={id:k(e.internalDocumentIDStore,d),score:p,document:r},a.add(d)}}return i}function U(e,t){e.internalDocumentIDStore.load(e,t.internalDocumentIDStore),e.data.index=e.index.load(e.internalDocumentIDStore,t.index),e.data.docs=e.documentsStore.load(e.internalDocumentIDStore,t.docs),e.data.sorting=e.sorter.load(e.internalDocumentIDStore,t.sorting),e.data.pinning=e.pinning.load(e.internalDocumentIDStore,t.pinning),e.tokenizer.language=t.language}async function Oe(e,t,o={}){const n=H(t);return(await Z(e,{term:t,tolerance:1,...o,boost:{title:2,..."boost"in o?o.boost:void 0}})).hits.map(s=>({type:"page",content:n.highlightMarkdown(s.document.title),breadcrumbs:s.document.breadcrumbs,id:s.document.url,url:s.document.url}))}async function ke(e,t,o=[],{mode:n="fulltext",...s}={}){typeof o=="string"&&(o=[o]);const i={...s,mode:n,where:ee({tags:o.length>0?{containsAll:o}:void 0,...s.where}),limit:10,groupBy:{properties:["page_id"],maxResult:8,...s.groupBy}};t.length>0&&Object.assign(i,{term:t,properties:n==="fulltext"?["content"]:["content","embeddings"]});const a=H(t),c=await Z(e,i),g=[];for(const d of c.groups??[]){const p=d.values[0],r=ie(e,p);if(r){g.push({id:p,type:"page",content:a.highlightMarkdown(r.content),breadcrumbs:r.breadcrumbs,url:r.url});for(const h of d.result)h.document.type!=="page"&&g.push({id:h.document.id.toString(),content:a.highlightMarkdown(h.document.content),breadcrumbs:h.document.breadcrumbs,type:h.document.type,url:h.document.url})}}return g.length>80?g.slice(0,80):g}const z=new Map;async function Ae({from:e="/api/search",initOrama:t=o=>re({schema:{_:"string"},language:o})}){const o=e,n=z.get(o);if(n)return n;async function s(){const a=await fetch(e);if(!a.ok)throw new Error(`failed to fetch exported search indexes from ${e}, make sure the search database is exported and available for client.`);const c=await a.json(),g=new Map;if(c.type==="i18n")return await Promise.all(Object.entries(c.data).map(async([p,r])=>{const h=await t(p);U(h,r),g.set(p,{type:r.type,db:h})})),g;const d=await t();return U(d,c),g.set("",{type:c.type,db:d}),g}const i=s();return z.set(o,i),i}async function _e(e,t){const{tag:o,locale:n}=t,s=(await Ae(t)).get(n??"");return s?s.type==="simple"?Oe(s,e):ke(s.db,e,o):[]}export{_e as search};
